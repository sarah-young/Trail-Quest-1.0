{% extends 'base.html' %}
{% block title %}
Homepage
{% endblock %}

{% block content %}

	<h2></h2>
	<h4>Let's get trekkin'. Fill out the boxes below to start.</h4>
	<form action='/trail_selector' id="trailSelector">

		<i><h4>Find trails near...</h4></i>
		City:<br>
	    	<input type="text" name="city" id="cityname" required><br>

	    State:<br>
	    	<input type="text" name="state" id="statename" required><br>

	    Distance from location:<br>
	    <div class="slidecontainer">
	 	 		<input type="range" min="1" max="25" value="5" class="slider" id="radius-selection" name="radius">
	 	 		<span id="radius"></span>
			</div>

	    Trail length:<br>
	    <i>(in miles)</i><br>
		    <div class="slidecontainer">
	 	 		<input type="range" min="1" max="30" value="15" class="slider" id="trek_length_selection" name="trek_length">
	 	 		<span id="trek_length"></span>
			</div>

	    Difficulty rating:
		    <select name="trail_difficulty" id="traildifficulty">
			  <option value="no-preference">No preference</option>
			  <option value="easy">Easy</option>
			  <option value="moderate">Moderate</option>
			  <option value="difficult">Difficult</option>
			</select><br>



	</form>

	<button type="button" id="asynchronousClick">Click Me!</button>

	<div id="map"></div>

	<div id="trek"></div>

<script>

$('#asynchronousClick').on('click', getTrails);

// When button clicked, trail selected and more information displayed.

function getTrails(evt) {

		let data = {"city": document.getElementById("cityname"),
								"state": document.getElementById("statename"),
								"radius": document.getElementById("radius-selection"),
								"traillength": document.getElementById("trek_length_selection"),
								"traildifficulty": document.getElementById("traildifficulty")
		} // end of data object

			$.ajax({
				url: "/trails_asychronous",
				type: "POST",
				data: $('#trailSelector').serialize(),
				processData: false,
				cache: true,
				success: function(response) {
					// displayTrails(response);
					// Calling displayTrails function to display three trails
					// Extracts trail id to call rest of information from Database
					initMap(response);
					// Calling initMap function to display Google Map
					// Ideally replace response with the trail object from the database
					markerPlacement(response);
					// Ideally replace response with the trail object from the database
				}, // end of response function

			  error: function(error) {
					console.log(error);
			  } // end of error handling function
			 }); // end of AJAX deets section
		}; //end of function getTrails

function initMap(response) {
		console.log(response);
		console.log("Here");
		let trailLong = response[0].city_long;
		let trailLat = response[0].city_lat;
		let infoWindow = new google.maps.InfoWindow({
        width: 150
		});
		let html;
		console.log(trailLong);
		console.log(trailLat);
		// lat and lng are not coming through as integers :(
	  let location = {lat: trailLat, lng: trailLong}; //latitude and longitude for city
	  let map = new google.maps.Map(document.getElementById('map'), {
	    zoom: 8,
	    center: location
		}); // end of jQuery statement

	  let marker = new google.maps.Marker({
	    position: location,
	    map: map
		}); // end of marker statement
			// markerPlacement(response);
		let trailMarker; // adding marker as a variable in the namespace

		for (let j = 0; j < response.length; j += 1) {
			trailMarker = new google.maps.Marker({
			position: new google.maps.LatLng(response[j].latitude, response[j].longitude),
			map: map,
			title: 'Trail: ' + response[j].name,
			icon: '/static/img/hikingIcon.png',
			animation: google.maps.Animation.DROP,
			});
			html = ('<div class="window-content">' +
              '<img src="'+response[j].imgSmall+'" alt="trailimage" style="width:100%;" class="thumbnail">' +
              '<p><b>Trail name: </b>' + response[j].name + '</p>' +
              '</div>');
			bindInfoWindow(trailMarker, map, infoWindow, html);
		} // end of trailMarker for loop
		console.log('Here: radius');
		let circle = new google.maps.Circle({ // circle for user chosen radius on map
			map: map,
			radius: response[0].radius_in_meters,
			fillColor: '#b394d1',
			strokeWeight: .1
		}); // end of circle statement
		circle.bindTo('center', marker, 'position');
		drop(response);
		toggleBounce();
} //end of initMap function

function drop(response) { //marker animation for REASONS
  for (let k = 0; k < response.length; k++) {
    setTimeout(function() {
    }, k * 200);
  }
} //end of drop function

function toggleBounce() { //cute BOUNCE when markers drop <3
	if (trailMarker.getAnimation() !== null) {
		trailMarker.setAnimation(null);
	} //end of if
	else {
		trailMarker.setAnimation(google.maps.Animation.BOUNCE);
	} //end of else
} //end of toggleBounce function

function bindInfoWindow(trailMarker, map, infoWindow, html) { //infoWindow for each trail; might do away with text outside this!
        google.maps.event.addListener(trailMarker, 'click', function () {
            infoWindow.close();
            infoWindow.setContent(html);
            infoWindow.open(map, trailMarker);
        });
} //end of bindInfoWindow function

google.maps.event.addDomListener(window, 'load', initMap);

</script>
<script async defer
src="https://maps.googleapis.com/maps/api/js?key=AIzaSyBT4L9G5iunkBWCBwqqm6Qdt7-0hG34L6Y&callback=initMap">
</script>

			<script src='../static/homepage.js' type="text/javascript">
			</script>

{% endblock %}
